---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: staging-ldap
  labels:
    app: ldap
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ldap
  template:
    metadata:
      labels:
        app: ldap
    spec:
      containers:
        - name: ldap
          image: osixia/openldap:1.1.11
          args:
            - "--copy-service"
          volumeMounts:
            - name: ldap-data
              mountPath: /var/lib/ldap
            - name: ldap-config
              mountPath: /etc/ldap/slapd.d
            - name: ldap-certs
              mountPath: /container/service/slapd/assets/certs
            - name: configmap-volume
              mountPath: /container/environment/01-custom
            - name: container-run
              mountPath: /container/run
          ports:
            - containerPort: 389
              name: openldap
      volumes:
        - name: ldap-data
          emptyDir: {}
        - name: ldap-config
          emptyDir: {}
        - name: ldap-certs
          emptyDir: {}
        - name: configmap-volume
          configMap:
            name: staging-ldap-configmap-4d7m6k5b42
        - name: container-run
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: staging-ldap-service
  labels:
    app: ldap
spec:
  ports:
    - port: 389
  selector:
    app: ldap
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: staging-ldap-configmap-4d7m6k5b42
data:
  env.startup.txt: "# This is the default image startup configuration file\n# this file define environment variables used during the container **first start** in **startup files**.\n\n# This file is deleted right after startup files are processed for the first time,\n# after that all these values will not be available in the container environment.\n# This helps to keep your container configuration secret.\n# more information : https://github.com/osixia/docker-light-baseimage\n\n# Required and used for new ldap server only\nLDAP_ORGANISATION: Example Inc.\nLDAP_DOMAIN: example.org\nLDAP_BASE_DN: #if empty automatically set from LDAP_DOMAIN\n\nLDAP_ADMIN_PASSWORD: admin\nLDAP_CONFIG_PASSWORD: config\n\nLDAP_READONLY_USER: false\nLDAP_READONLY_USER_USERNAME: readonly\nLDAP_READONLY_USER_PASSWORD: readonly\n\nLDAP_RFC2307BIS_SCHEMA: false\n\n# Backend\nLDAP_BACKEND: hdb\n\n# Tls\nLDAP_TLS: true\nLDAP_TLS_CRT_FILENAME: ldap.crt\nLDAP_TLS_KEY_FILENAME: ldap.key\nLDAP_TLS_CA_CRT_FILENAME: ca.crt\n\nLDAP_TLS_ENFORCE: false\nLDAP_TLS_CIPHER_SUITE: SECURE256:+SECURE128:-VERS-TLS-ALL:+VERS-TLS1.2:-RSA:-DHE-DSS:-CAMELLIA-128-CBC:-CAMELLIA-256-CBC\nLDAP_TLS_VERIFY_CLIENT: demand\n\n# Replication\nLDAP_REPLICATION: false\n# variables $LDAP_BASE_DN, $LDAP_ADMIN_PASSWORD, $LDAP_CONFIG_PASSWORD\n# are automaticaly replaced at run time\n\n# if you want to add replication to an existing ldap\n# adapt LDAP_REPLICATION_CONFIG_SYNCPROV and LDAP_REPLICATION_DB_SYNCPROV to your configuration\n# avoid using $LDAP_BASE_DN, $LDAP_ADMIN_PASSWORD and $LDAP_CONFIG_PASSWORD variables\nLDAP_REPLICATION_CONFIG_SYNCPROV: binddn=\"cn=admin,cn=config\" bindmethod=simple credentials=$LDAP_CONFIG_PASSWORD searchbase=\"cn=config\" type=refreshAndPersist retry=\"60 +\" timeout=1 starttls=critical\nLDAP_REPLICATION_DB_SYNCPROV: binddn=\"cn=admin,$LDAP_BASE_DN\" bindmethod=simple credentials=$LDAP_ADMIN_PASSWORD searchbase=\"$LDAP_BASE_DN\" type=refreshAndPersist interval=00:00:00:10 retry=\"60 +\" timeout=1 starttls=critical\nLDAP_REPLICATION_HOSTS:\n  - ldap://ldap.example.org # The order must be the same on all ldap servers\n  - ldap://ldap2.example.org\n\n\n# Do not change the ldap config\n# - If set to true with an existing database, config will remain unchanged. Image tls and replication config will not be run.\n#   The container can be started with LDAP_ADMIN_PASSWORD and LDAP_CONFIG_PASSWORD empty or filled with fake data.\n# - If set to true when bootstrapping a new database, bootstap ldif and schema will not be added and tls and replication config will not be run.\nKEEP_EXISTING_CONFIG: false\n\n# Remove config after setup\nLDAP_REMOVE_CONFIG_AFTER_SETUP: true\n\n# ssl-helper environment variables prefix\nLDAP_SSL_HELPER_PREFIX: ldap # ssl-helper first search config from LDAP_SSL_HELPER_* variables, before SSL_HELPER_* variables.\n"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: staging-env-config-42m8gk5kg2
data:
  config.env: |
    DB_USERNAME=admin
    DB_PASSWORD=somepw
